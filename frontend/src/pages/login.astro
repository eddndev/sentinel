---
import "../styles/global.css";
---

<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <title>Login | Sentinel</title>
    </head>
    <body
        class="bg-slate-950 min-h-screen flex items-center justify-center font-mono text-slate-200 antialiased relative overflow-hidden"
    >
        <!-- Background Ambient -->
        <div class="fixed top-0 left-0 w-full h-full pointer-events-none">
            <div
                class="absolute top-[-20%] left-[-10%] w-[50%] h-[50%] bg-brand-purple/5 blur-[120px] rounded-full"
            >
            </div>
            <div
                class="absolute bottom-[-20%] right-[-10%] w-[50%] h-[50%] bg-brand-purple/5 blur-[120px] rounded-full"
            >
            </div>
        </div>

        <!-- Login Container -->
        <main class="w-full max-w-md p-8 relative z-10" x-data="loginForm">
            <!-- Header -->
            <div class="mb-12 text-center">
                <h1 class="text-4xl font-bold tracking-tighter uppercase mb-2">
                    Sentinel <span
                        class="text-brand-purple text-xs tracking-[0.3em] align-top"
                        >ID</span
                    >
                </h1>
                <p
                    class="text-xs font-mono text-slate-500 uppercase tracking-widest"
                >
                    Authorized Personnel Only
                </p>
            </div>

            <!-- Form -->
            <form @submit.prevent="submit" class="space-y-6 relative group">
                <!-- Decorations -->
                <div class="cross-marker -top-4 -left-4"></div>
                <div class="cross-marker -top-4 -right-4"></div>
                <div class="cross-marker -bottom-4 -left-4"></div>
                <div class="cross-marker -bottom-4 -right-4"></div>

                <div
                    class="p-8 bg-brand-panel/30 border border-white/5 backdrop-blur-md relative"
                >
                    <!-- Error Message -->
                    <div
                        x-show="errorMessage"
                        x-transition
                        class="mb-6 p-3 border border-red-500/30 bg-red-500/10 text-red-200 text-xs font-mono text-center"
                    >
                        <span x-text="errorMessage"></span>
                    </div>

                    <!-- Email -->
                    <div class="space-y-2">
                        <label
                            class="text-[10px] uppercase tracking-widest text-slate-400"
                            >Identity</label
                        >
                        <input
                            type="email"
                            x-model="email"
                            class="w-full bg-black/40 border border-white/10 text-white p-3 text-sm focus:border-brand-purple/50 focus:outline-none focus:ring-1 focus:ring-brand-purple/50 transition-all placeholder:text-white/20"
                            placeholder="admin@sentinel.com"
                            required
                        />
                    </div>

                    <!-- Password -->
                    <div class="space-y-2 mt-6">
                        <label
                            class="text-[10px] uppercase tracking-widest text-slate-400"
                            >Passcode</label
                        >
                        <input
                            type="password"
                            x-model="password"
                            class="w-full bg-black/40 border border-white/10 text-white p-3 text-sm focus:border-brand-purple/50 focus:outline-none focus:ring-1 focus:ring-brand-purple/50 transition-all placeholder:text-white/20"
                            placeholder="••••••••"
                            required
                        />
                    </div>

                    <!-- Submit -->
                    <button
                        type="submit"
                        class="w-full mt-8 bg-brand-purple text-white py-3 uppercase tracking-widest text-xs font-bold hover:bg-brand-purple/90 transition-all disabled:opacity-50 disabled:cursor-not-allowed border border-transparent hover:border-white/20"
                        :disabled="loading"
                    >
                        <span x-show="!loading">Authenticate</span>
                        <span x-show="loading" class="animate-pulse"
                            >Verifying...</span
                        >
                    </button>
                </div>
            </form>

            <!-- Footer -->
            <div class="mt-8 text-center">
                <p class="text-[10px] text-slate-600 font-mono">
                    SECURE CONNECTION // <span class="text-brand-purple"
                        >ENCRYPTED</span
                    >
                </p>
            </div>
        </main>

        <script>
            import { ApiClient as api } from "../lib/api";
            
            // Auth Helpers
            const setToken = (token: string) => localStorage.setItem('token', token);
            const setUser = (user: any) => localStorage.setItem('user', JSON.stringify(user));

            document.addEventListener("alpine:init", () => {
                Alpine.data("loginForm", () => ({
                    email: "",
                    password: "",
                    loading: false,
                    errorMessage: "",

                    async submit() {
                        this.loading = true;
                        this.errorMessage = ''; // Changed from this.error to match x-data

                        try {
                            console.log('Attempting login with:', this.email);
                            const response = await api.post('/auth/login', {
                                email: this.email,
                                password: this.password
                            });
                            
                            console.log('Login response:', response);

                            if (response.token) {
                                console.log('Token received, storing...');
                                setToken(response.token);
                                setUser(response.user);
                                console.log('Redirecting to /...');
                                window.location.href = '/'; 
                            } else {
                                console.error('No token in response');
                                this.errorMessage = 'Login failed: No token received';
                            }
                        } catch (err) {
                            console.error('Login error catch:', err);
                            this.errorMessage = err instanceof Error ? err.message : 'Login failed';
                        } finally {
                            this.loading = false;
                        }
                    }
                }));
            });
        </script>
    </body>
</html>
