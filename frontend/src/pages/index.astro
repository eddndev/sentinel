---
import Layout from "../layouts/Layout.astro";
import BotConnection from "../components/BotConnection.astro";

// Server-side Fetch (SSR)
const API_URL = import.meta.env.VITE_API_URL || "http://localhost:8080";
let bots = [];
let error = null;

try {
	const res = await fetch(`${API_URL}/bots`);
	if (res.ok) bots = await res.json();
} catch (e) {
	error = "Failed to load bots system";
}
---

<Layout title="Dashboard">
	<main class="space-y-8">
		<!-- Header -->
		<header
			class="flex justify-between items-center border-b border-white/10 pb-6 relative"
		>
			<div class="cross-marker -bottom-[5px] -left-[5px]"></div>
			<div class="cross-marker -bottom-[5px] -right-[5px]"></div>

			<h1
				class="text-3xl font-bold tracking-tighter uppercase relative z-10"
			>
				Sentinel <span
					class="text-brand-purple text-xs tracking-[0.3em] align-top ml-2"
					>v1.0.0</span
				>
			</h1>

			<div class="flex items-center gap-4">
				<div class="flex border border-white/10 overflow-hidden">
					<button
						@click="$store.i18n.setLocale('en')"
						class="px-3 py-1 text-[10px] font-mono transition-colors"
						:class="$store.i18n.locale === 'en' ? 'bg-brand-purple text-white' : 'text-white/40 hover:bg-white/5'"
						>EN</button
					>
					<button
						@click="$store.i18n.setLocale('es')"
						class="px-3 py-1 text-[10px] font-mono transition-colors border-l border-white/10"
						:class="$store.i18n.locale === 'es' ? 'bg-brand-purple text-white' : 'text-white/40 hover:bg-white/5'"
						>ES</button
					>
				</div>
				<div
					class="px-3 py-1 border border-white/20 text-xs font-mono text-white/60"
				>
					SYSTEM: {error ? "OFFLINE" : "ONLINE"}
				</div>
			</div>
		</header>

		<!-- Dynamic Grid Content -->
		<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
			<!-- Bot Status Cards -->
			{
				bots.length > 0 ? (
					bots.map((bot: any) => (
						<div class="col-span-1 bg-brand-panel/20 border border-white/5 p-1">
							<div class="flex justify-between items-center mb-2 px-2 pt-2">
								<h3 class="text-xs text-brand-purple uppercase tracking-widest">
									{bot.name}
								</h3>
								<a
									href={`/editor?botId=${bot.id}`}
									class="text-[10px] font-mono text-gray-500 hover:text-brand-purple transition-colors uppercase flex items-center gap-1"
								>
									<span x-text="$t('manage_flows')">
										Manage Flows
									</span>
									<svg
										class="w-3 h-3"
										fill="none"
										viewBox="0 0 24 24"
										stroke="currentColor"
									>
										<path
											stroke-linecap="round"
											stroke-linejoin="round"
											stroke-width="2"
											d="M14 5l7 7m0 0l-7 7m7-7H3"
										/>
									</svg>
								</a>
							</div>
							<BotConnection botId={bot.id} />
						</div>
					))
				) : (
					<div class="col-span-1 md:col-span-3 p-12 border border-dashed border-white/20 text-center text-gray-500 bg-brand-panel/20">
						<p class="text-sm uppercase tracking-widest mb-4">
							No Bots Online
						</p>
						<button class="px-6 py-2 bg-brand-purple text-white hover:bg-brand-purple/80 transition-colors uppercase text-xs tracking-wider">
							+ Create First Bot
						</button>
					</div>
				)
			}

			<!-- Stats Logic (Keep outside the loop or purely informational) -->
			<div
				class="p-6 bg-brand-panel/50 border border-white/5 backdrop-blur-sm relative group h-fit"
			>
				<h2
					class="text-xs text-brand-purple uppercase tracking-widest mb-4"
				>
					Total Flows
				</h2>
				<div class="text-4xl font-mono font-light">12</div>
			</div>

			<div
				class="p-6 bg-brand-panel/50 border border-white/5 backdrop-blur-sm relative group h-fit"
			>
				<h2
					class="text-xs text-brand-purple uppercase tracking-widest mb-4"
				>
					Executions
				</h2>
				<div class="text-4xl font-mono font-light text-green-400">
					843
				</div>
			</div>
		</div>
	</main>
</Layout>
