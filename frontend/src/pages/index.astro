---
import Layout from "../layouts/Layout.astro";
import BotConnection from "../components/BotConnection.astro";

// Server-side Fetch (SSR)
const API_URL = import.meta.env.VITE_API_URL || "http://localhost:8080";
let bots = [];
let error = null;

try {
	const res = await fetch(`${API_URL}/bots`);
	if (res.ok) bots = await res.json();
} catch (e) {
	error = "Failed to load bots system";
}
---

<Layout title="Dashboard">
	<main class="space-y-8">
		<!-- Header -->
		<header
			class="flex justify-between items-center border-b border-white/10 pb-6 relative"
		>
			<div class="cross-marker -bottom-[5px] -left-[5px]"></div>
			<div class="cross-marker -bottom-[5px] -right-[5px]"></div>

			<h1
				class="text-3xl font-bold tracking-tighter uppercase relative z-10"
			>
				Sentinel <span
					class="text-brand-purple text-xs tracking-[0.3em] align-top ml-2"
					>v1.0.0</span
				>
			</h1>

			<div class="flex items-center gap-4">
				<div
					class="px-3 py-1 border border-white/20 text-xs font-mono text-white/60"
				>
					SYSTEM: {error ? "OFFLINE" : "ONLINE"}
				</div>
			</div>
		</header>

		<!-- Dynamic Grid Content -->
		<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
			<!-- Bot Status Cards -->
			{
				bots.length > 0 ? (
					bots.map((bot: any) => (
						<div class="col-span-1">
							<h3 class="text-xs text-brand-purple uppercase tracking-widest mb-2 pl-1">
								{bot.name}
							</h3>
							<BotConnection botId={bot.id} />
						</div>
					))
				) : (
					<div class="col-span-1 md:col-span-3 p-12 border border-dashed border-white/20 text-center text-gray-500 bg-brand-panel/20">
						<p class="text-sm uppercase tracking-widest mb-4">
							No Bots Online
						</p>
						<button class="px-4 py-2 bg-brand-purple/20 text-brand-purple border border-brand-purple/50 hover:bg-brand-purple/40 transition-colors uppercase text-xs tracking-wider">
							+ Create First Bot
						</button>
					</div>
				)
			}

			<!-- Stats Logic (Keep outside the loop or purely informational) -->
			<div
				class="p-6 bg-brand-panel/50 border border-white/5 backdrop-blur-sm relative group h-fit"
			>
				<h2
					class="text-xs text-brand-purple uppercase tracking-widest mb-4"
				>
					Total Flows
				</h2>
				<div class="text-4xl font-mono font-light">12</div>
			</div>

			<div
				class="p-6 bg-brand-panel/50 border border-white/5 backdrop-blur-sm relative group h-fit"
			>
				<h2
					class="text-xs text-brand-purple uppercase tracking-widest mb-4"
				>
					Executions
				</h2>
				<div class="text-4xl font-mono font-light text-green-400">
					843
				</div>
			</div>
		</div>
	</main>
</Layout>
