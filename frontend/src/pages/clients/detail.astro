---
import Layout from "../../layouts/Layout.astro";
import ClientModal from "../../components/clients/ClientModal.astro";

// Static Page: No server-side params. ID is fetched client-side.
---

<Layout title="Client Detail">
    <div
        x-data={`{
        client: {},
        loading: true,
        revealedPassword: null,
        clientId: '', // Populated in init
        showEdit: false,

        async fetchClient() {
            if (!this.clientId) {
                alert('No Client ID provided');
                this.loading = false;
                return;
            }
            try {
                this.client = await ApiClient.get('/clients/' + this.clientId);
            } catch (e) {
                console.error(e);
                alert('Error loading client');
            } finally {
                this.loading = false;
            }
        },

        async revealPassword() {
            try {
                const data = await ApiClient.get('/clients/' + this.clientId + '?reveal=true');
                this.revealedPassword = data.plainTextPassword;
            } catch (e) {
                alert('Error revealing password');
            }
        },

        async deleteClient() {
            if (!confirm('Are you sure you want to delete this client?')) return;
            try {
                await ApiClient.delete('/clients/' + this.clientId);
                window.location.href = '/bots/detail?id=' + this.client.botId; 
            } catch (e) {
                alert('Error deleting client');
            }
        },

        init() {
            // Client-side ID extraction
            const params = new URLSearchParams(window.location.search);
            this.clientId = params.get('id');
            
            this.fetchClient();
        }
    }`}
    >
        <!-- Loading -->
        <div x-show="loading" class="flex justify-center py-20">
            <span class="animate-pulse text-brand-purple">Loading...</span>
        </div>

        <div x-show="!loading" x-cloak class="max-w-4xl mx-auto space-y-8">
            <!-- Header -->
            <header
                class="flex justify-between items-start border-b border-white/10 pb-6 relative"
            >
                <div class="cross-marker -bottom-[5px] -left-[5px]"></div>
                <div class="cross-marker -bottom-[5px] -right-[5px]"></div>

                <div>
                    <a
                        :href="client.botId ? '/bots/detail?id=' + client.botId : '#'"
                        class="text-xs text-gray-500 hover:text-white transition-colors mb-2 block"
                        >‚Üê Volver al Bot</a
                    >
                    <h1
                        class="text-3xl font-bold uppercase tracking-tight flex items-center gap-3"
                    >
                        <span x-text="client.name"></span>
                        <span
                            class="px-2 py-1 rounded text-[10px] uppercase font-bold tracking-wide border border-white/10"
                            :class="{
                                'bg-yellow-500/20 text-yellow-500': client.status === 'LINEA_DE_CAPTURA_CREADA',
                                'bg-blue-500/20 text-blue-500': client.status === 'CITA_AGENDADA',
                                'bg-red-500/20 text-red-500': client.status === 'PAGO_PENDIENTE',
                                'bg-green-500/20 text-green-500': client.status === 'PAGADO'
                            }"
                            x-text="client.status ? client.status.replace(/_/g, ' ') : 'PENDIENTE'"
                        >
                        </span>
                    </h1>
                    <p
                        class="text-sm font-mono text-brand-purple mt-1"
                        x-text="client.email"
                    >
                    </p>
                </div>

                <div class="flex gap-3">
                    <button
                        @click="showEdit = true"
                        class="px-4 py-2 border border-white/10 text-gray-400 hover:text-white hover:bg-white/5 rounded-full text-xs uppercase font-mono"
                    >
                        Editar
                    </button>
                    <button
                        @click="deleteClient()"
                        class="px-4 py-2 border border-red-500/30 text-red-500 hover:bg-red-500/10 rounded-full text-xs uppercase font-mono"
                    >
                        Eliminar
                    </button>
                </div>
            </header>

            <!-- Info Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Personal Info -->
                <div
                    class="bg-brand-panel/30 border border-white/5 p-6 relative"
                >
                    <div class="cross-marker -top-[2px] -left-[2px]"></div>
                    <div class="cross-marker -top-[2px] -right-[2px]"></div>
                    <h3
                        class="text-xs text-brand-purple uppercase tracking-widest mb-4"
                    >
                        Informaci√≥n Personal
                    </h3>

                    <div class="space-y-4">
                        <div>
                            <span
                                class="block text-[10px] uppercase text-gray-500"
                                >Tel√©fono (ID)</span
                            >
                            <span
                                class="text-white font-mono"
                                x-text="client.phoneNumber"></span>
                        </div>
                        <div>
                            <span
                                class="block text-[10px] uppercase text-gray-500"
                                >Tel√©fono Contacto</span
                            >
                            <span
                                class="text-white font-mono"
                                x-text="client.contactNumber || '-'"></span>
                        </div>
                        <div>
                            <span
                                class="block text-[10px] uppercase text-gray-500"
                                >Fecha Cita</span
                            >
                            <span
                                class="text-white font-mono"
                                x-text="client.appointmentDate ? new Date(client.appointmentDate).toLocaleString() : '-'"
                            ></span>
                        </div>
                        <div>
                            <span
                                class="block text-[10px] uppercase text-gray-500"
                                >L√≠nea de Captura</span
                            >
                            <span
                                class="text-white font-mono"
                                x-text="client.captureLine || '-'"></span>
                        </div>
                    </div>
                </div>

                <!-- Security & Files -->
                <div
                    class="bg-brand-panel/30 border border-white/5 p-6 relative"
                >
                    <div class="cross-marker -top-[2px] -left-[2px]"></div>
                    <div class="cross-marker -top-[2px] -right-[2px]"></div>
                    <h3
                        class="text-xs text-brand-purple uppercase tracking-widest mb-4"
                    >
                        Seguridad y Archivos
                    </h3>

                    <div class="mb-6">
                        <span
                            class="block text-[10px] uppercase text-gray-500 mb-2"
                            >Contrase√±a</span
                        >
                        <div class="flex items-center gap-2">
                            <input
                                type="text"
                                readonly
                                :value="revealedPassword || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'"
                                class="bg-black/40 border border-white/10 px-3 py-2 text-sm text-gray-300 w-full font-mono rounded"
                            />
                            <button
                                @click="revealPassword()"
                                class="p-2 border border-white/10 hover:bg-white/5 rounded text-gray-400"
                                title="Revelar"
                            >
                                üëÅÔ∏è
                            </button>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <template
                            x-for="(path, label) in { 
                            'PDF Cita': client.appointmentPdfPath,
                            'PDF Constancia': client.accreditationPdfPath,
                            'PDF Captura': client.captureLinePdfPath
                        }"
                        >
                            <div
                                x-show="path"
                                class="flex justify-between items-center p-2 bg-white/5 rounded border border-white/5"
                            >
                                <span
                                    class="text-xs text-gray-400"
                                    x-text="label"></span>
                                <a
                                    :href="path"
                                    target="_blank"
                                    class="text-brand-purple hover:underline text-xs flex items-center gap-1"
                                >
                                    Abrir ‚Üó
                                </a>
                            </div>
                        </template>
                        <div
                            x-show="!client.appointmentPdfPath && !client.accreditationPdfPath && !client.captureLinePdfPath"
                            class="text-xs text-gray-500 italic"
                        >
                            No hay archivos adjuntos.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Modal Wrapper -->
            <template x-if="showEdit">
                <div class="fixed inset-0 z-50">
                    <div
                        class="absolute inset-0 bg-black/80"
                        @click="showEdit = false"
                    >
                    </div>
                    <!-- Edit Form (Inline duplication for simplicity in static mode) -->
                    <div
                        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl bg-[#1a1a1a] border border-white/10 rounded-xl p-6 shadow-2xl"
                    >
                        <h2 class="text-xl font-bold text-white mb-6">
                            Editar Cliente
                        </h2>
                        <form
                            @submit.prevent="async () => {
                             try {
                                 const payload = { ...client };
                                  if (client.newPassword) payload.plainTextPassword = client.newPassword;
                                  delete payload.newPassword;
                                  
                                  await ApiClient.put('/clients/' + clientId, payload);
                                  window.location.reload();
                             } catch(e) { alert(e); }
                         }"
                        >
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="text-xs text-gray-500"
                                        >Nombre</label
                                    ><input
                                        x-model="client.name"
                                        class="w-full bg-black/40 border-white/10 text-white p-2 rounded"
                                    />
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500"
                                        >Email</label
                                    ><input
                                        x-model="client.email"
                                        class="w-full bg-black/40 border-white/10 text-white p-2 rounded"
                                    />
                                </div>
                            </div>

                            <div class="mb-4">
                                <label
                                    class="block text-xs uppercase text-gray-500 mb-1"
                                    >Estatus</label
                                >
                                <select
                                    x-model="client.status"
                                    class="w-full bg-black/40 border border-white/10 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                                >
                                    <option value="LINEA_DE_CAPTURA_CREADA"
                                        >L√≠nea de Captura Creada</option
                                    >
                                    <option value="CITA_AGENDADA"
                                        >Cita Agendada</option
                                    >
                                    <option value="PAGO_PENDIENTE"
                                        >Pago Pendiente</option
                                    >
                                    <option value="PAGADO">Pagado</option>
                                </select>
                            </div>
                            <!-- 'Llave' fields are usually immutable ID but name/email editing permitted. To keep full edits use ClientModal approach but for fix speed: -->
                            <div class="mb-4">
                                <label class="text-xs text-gray-500"
                                    >Nueva Contrase√±a (Opcional)</label
                                >
                                <input
                                    x-model="client.newPassword"
                                    type="text"
                                    placeholder="Dejar vac√≠o para mantener actual"
                                    class="w-full bg-black/40 border-white/10 text-white p-2 rounded"
                                />
                            </div>

                            <div class="flex justify-end gap-2 mt-6">
                                <button
                                    type="button"
                                    @click="showEdit = false"
                                    class="px-4 py-2 text-gray-400"
                                    >Cancelar</button
                                >
                                <button
                                    type="submit"
                                    class="px-4 py-2 bg-brand-purple text-white rounded"
                                    >Guardar</button
                                >
                            </div>
                        </form>
                    </div>
                </div>
            </template>
        </div>
    </div>
</Layout>

<script>
    import { ApiClient } from "../../lib/api";
    // Make available to Alpine
    window.ApiClient = ApiClient;
</script>
