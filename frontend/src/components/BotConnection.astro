---
interface Props {
    botId: string;
}

const { botId } = Astro.props;
---

<div
    x-data={`botConnection('${botId}')`}
    class="connection-panel p-4 bg-gray-900/50 border border-white/10 rounded-lg backdrop-blur-md"
>
    <script>
        import { ApiClient } from "../lib/api";

        document.addEventListener("alpine:init", () => {
            Alpine.data("botConnection", (botId) => ({
                botId,
                status: "DISCONNECTED",
                qr: null,
                loading: false,
                pollInterval: null,

                async init() {
                    this.checkStatus();
                    // @ts-ignore
                    this.pollInterval = setInterval(
                        () => this.checkStatus(),
                        2000,
                    );

                    // @ts-ignore
                    this.$cleanup(() => clearInterval(this.pollInterval));
                },

                async checkStatus() {
                    try {
                        const res = await ApiClient.get(
                            `/bots/${this.botId}/status`,
                        );

                        if (res.connected) {
                            this.status = "CONNECTED";
                            this.qr = null;
                        } else if (res.hasQr) {
                            this.status = "SCAN_QR";
                            // Fetch QR
                            const qrRes = await ApiClient.get(
                                `/bots/${this.botId}/qr`,
                            );
                            this.qr = qrRes.qr;
                        } else {
                            this.status = "DISCONNECTED";
                            this.qr = null;
                        }
                    } catch (e) {
                        console.error("Status check failed", e);
                    }
                },

                async connect() {
                    this.loading = true;
                    try {
                        await ApiClient.post(`/bots/${this.botId}/connect`, {});
                        setTimeout(() => this.checkStatus(), 1000);
                    } catch (e) {
                        // @ts-ignore
                        alert(this.$t("error"));
                    } finally {
                        this.loading = false;
                    }
                },

                async disconnect() {
                    // @ts-ignore
                    if (!confirm(this.$t("disconnect") + "?")) return;
                },
            }));
        });
    </script>

    <div class="flex items-center justify-between mb-4">
        <h3
            class="text-sm font-bold text-gray-400 uppercase tracking-widest"
            x-text="$t('whatsapp_baileys')"
        >
        </h3>

        <span
            class="px-2 py-0.5 text-[10px] font-mono border rounded"
            :class="{
                'border-green-500/50 text-green-400 bg-green-500/10': status === 'CONNECTED',
                'border-yellow-500/50 text-yellow-400 bg-yellow-500/10': status === 'SCAN_QR',
                'border-red-500/50 text-red-400 bg-red-500/10': status === 'DISCONNECTED'
              }"
            x-text="status === 'CONNECTED' ? $t('active') : (status === 'SCAN_QR' ? $t('scan_qr') : $t('disconnected'))"
        >
        </span>
    </div>

    <!-- QR View -->
    <template x-if="status === 'SCAN_QR' && qr">
        <div class="text-center py-4">
            <img
                :src="qr"
                class="w-48 h-48 mx-auto border-4 border-white rounded-lg shadow-2xl"
            />
            <p
                class="mt-4 text-xs text-gray-400 font-mono animate-pulse"
                x-text="$t('scan_whatsapp')"
            >
            </p>
        </div>
    </template>

    <!-- Connect Button -->
    <template x-if="status === 'DISCONNECTED'">
        <button
            @click="connect()"
            :disabled="loading"
            class="w-full py-2 px-4 bg-brand-purple hover:bg-brand-purple/80 text-white font-mono text-xs uppercase tracking-wider transition-colors disabled:opacity-50"
        >
            <span x-show="!loading" x-text="$t('start_connection')"></span>
            <span x-show="loading" x-text="$t('initializing')"></span>
        </button>
    </template>

    <!-- Connected View -->
    <template x-if="status === 'CONNECTED'">
        <div class="text-center py-8">
            <div
                class="w-16 h-16 bg-green-500/20 text-green-400 rounded-full flex items-center justify-center mx-auto mb-2 border border-green-500/50 shadow-[0_0_15px_rgba(34,197,94,0.3)]"
            >
                <svg
                    class="w-8 h-8"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    ><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M5 13l4 4L19 7"></path></svg
                >
            </div>
            <p
                class="text-xs text-green-400 font-mono uppercase tracking-widest"
            >
                System Online
            </p>
        </div>
    </template>
</div>
